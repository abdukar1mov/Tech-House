<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savatcha - Tech House</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body data-title-key="title.cart">

    <!-- Header -->
    <header class="header">
        <!-- Top Bar -->
        <div class="header__top">
            <div class="container header__top-container">
                <p class="header__top-text" data-i18n="header.free_delivery">Bepul yetkazib berish 500,000 so'mdan
                    yuqori xaridlar uchun!</p>
                <div class="header__top-links">
                    <div class="lang-switcher">
                        <button class="lang-btn" onclick="changeLanguage('uz')" data-lang="uz">UZ</button>
                        <button class="lang-btn active" onclick="changeLanguage('en')" data-lang="en">EN</button>
                    </div>
                    <a href="help.html" data-i18n="nav.help">Help</a>
                    <a href="membership.html" data-i18n="nav.membership">Membership</a>
                </div>
            </div>
        </div>

        <!-- Main Header -->
        <div class="header__main">
            <div class="container header__main-container">
                <a href="index.html" class="logo-wrapper">
                    <div class="logo-box">TH</div>
                    <div class="logo-text">
                        <span class="logo-title">Tech House</span>
                        <span class="logo-subtitle" data-i18n="header.subtitle">Smart Living Solutions</span>
                    </div>
                </a>

                <div class="header__search">
                    <div class="search-box">
                        <i data-lucide="search"></i>
                        <input type="text" placeholder="Mahsulotlarni qidiring..."
                            data-i18n="header.search_placeholder">
                    </div>
                </div>

                <div class="header__user-actions">
                    <button class="user-action-btn"><i data-lucide="user"></i></button>
                    <a href="cart.html" class="user-action-btn active">
                        <i data-lucide="shopping-cart"></i>
                        <span class="nav__badge">0</span>
                    </a>
                    <button id="nav-toggle" class="nav__toggle">
                        <i data-lucide="menu"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="nav__overlay" id="nav-overlay"></div>

        <!-- Bottom Navigation -->
        <nav class="nav">
            <div class="container nav__container">
                <ul class="nav__list">
                    <li><a href="index.html" class="nav__link" data-i18n="nav.home">Bosh sahifa</a></li>
                    <li><a href="about.html" class="nav__link" data-i18n="nav.about">Biz haqimizda</a></li>
                    <li><a href="categories.html" class="nav__link" data-i18n="nav.categories">Kategoriyalar</a></li>
                    <li><a href="membership.html" class="nav__link" data-i18n="nav.membership">A'zolik</a></li>
                    <li><a href="help.html" class="nav__link" data-i18n="nav.help">Yordam</a></li>
                </ul>
                <div class="nav__mobile-lang">
                    <div class="lang-switcher">
                        <button class="lang-btn" onclick="changeLanguage('uz')" data-lang="uz">UZ</button>
                        <button class="lang-btn active" onclick="changeLanguage('en')" data-lang="en">EN</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div class="container">
            <h1 class="section__title"><span data-i18n="cart.title">Savatcha</span> (<span
                    id="cart-title-count">0</span>)</h1>

            <div class="cart-grid">
                <!-- Cart Items -->
                <div id="cart-items-container" class="cart-items">
                    <div class="loading">Yuklanmoqda...</div>
                </div>

                <!-- Order Summary -->
                <aside class="cart-summary">
                    <div class="summary-card">
                        <h3 data-i18n="cart.order_summary">Buyurtma xulasasi</h3>

                        <!-- Delivery Method Selector -->
                        <div class="delivery-methods">
                            <button id="method-delivery" class="method-btn active"
                                onclick="setDeliveryMethod('delivery')">
                                <i data-lucide="truck"></i> <span data-i18n="cart.delivery">Yetkazib berish</span>
                            </button>
                            <button id="method-pickup" class="method-btn" onclick="setDeliveryMethod('pickup')">
                                <i data-lucide="map-pin"></i> <span data-i18n="cart.pickup">Olib ketish</span>
                            </button>
                        </div>

                        <!-- Delivery Info Inputs -->
                        <div id="delivery-info" class="delivery-info">
                            <div class="form-group">
                                <label for="delivery-address" class="input-label"
                                    data-i18n="cart.address_label">Manzil</label>
                                <div class="input-wrapper">
                                    <i data-lucide="map-pin"></i>
                                    <input type="text" id="delivery-address" class="form-input"
                                        placeholder="Ko'cha, uy, xonadon..."
                                        data-i18n-placeholder="cart.address_placeholder">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="delivery-phone" class="input-label" data-i18n="cart.phone_label">Telefon
                                    raqam</label>
                                <div class="input-wrapper">
                                    <i data-lucide="phone"></i>
                                    <input type="tel" id="delivery-phone" class="form-input"
                                        placeholder="+998 90 123 45 67" data-i18n-placeholder="cart.phone_placeholder">
                                </div>
                            </div>
                        </div>

                        <div id="pickup-info" class="pickup-info" style="display: none;">
                            <p class="pickup-label"><i data-lucide="info"></i> <span
                                    data-i18n="cart.pickup_select_branch">Filialni tanlang:</span></p>
                            <select id="branch-select" class="branch-select" onchange="updatePickupBranch()">
                                <!-- Branches will be populated by JS -->
                            </select>
                            <div id="selected-branch-address" class="branch-address">
                                <!-- Address will be shown here -->
                            </div>
                        </div>

                        <div class="summary-row">
                            <span><span data-i18n="cart.products">Mahsulotlar</span> (<span
                                    id="summary-count">0</span>):</span>
                            <span id="summary-subtotal">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span data-i18n="cart.delivery">Yetkazib berish:</span>
                            <span id="shipping-amount" class="free-text" data-i18n="cart.free">Bepul</span>
                        </div>
                        <div class="summary-divider"></div>
                        <div id="membership-discount-row" class="summary-row discount" style="display: none;">
                            <span>A'zolik chegirmasi (<span id="membership-tier-name">Bronze</span>):</span>
                            <span id="membership-discount-amount">-$0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span data-i18n="cart.total">Jami:</span>
                            <span id="summary-total">$0.00</span>
                        </div>
                        <button class="btn btn--primary w-100 mt-4" data-i18n="cart.checkout">Rasmiylashtirish</button>

                        <div id="membership-perks-box" class="membership-perks-box" style="display: none;">
                            <h4 data-i18n="membership.perks_title">Sizning imtiyozlaringiz:</h4>
                            <ul id="membership-perks-list"></ul>
                        </div>

                        <p class="secure-text">
                            <i data-lucide="shield-check"></i> <span data-i18n="cart.secure">Xavfsiz to'lov va maxfiylik
                                kafolati</span>
                        </p>
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer__grid">
                <div class="footer__col">
                    <div class="footer__logo">
                        <div class="footer__logo-icon">TH</div>
                        <div class="footer__logo-text">
                            <h3>Tech House</h3>
                            <span data-i18n="header.subtitle">Smart Living Solutions</span>
                        </div>
                    </div>
                    <p class="footer__about" data-i18n="footer.about">
                        Zamonaviy uy jihozlari va smart home texnologiyalari bo'yicha yetakchi kompaniya.
                    </p>
                    <div class="footer__socials">
                        <a href="#"><i data-lucide="facebook"></i></a>
                        <a href="#"><i data-lucide="instagram"></i></a>
                        <a href="#"><i data-lucide="twitter"></i></a>
                        <a href="#"><i data-lucide="youtube"></i></a>
                    </div>
                </div>

                <div class="footer__col">
                    <h4 class="footer__title" data-i18n="footer.col1_title">Tezkor havolalar</h4>
                    <ul class="footer__links">
                        <li><a href="categories.html" data-i18n="nav.categories">Kategoriyalar</a></li>
                        <li><a href="membership.html" data-i18n="membership.title">A'zolik dasturi</a></li>
                        <li><a href="help.html" data-i18n="footer.link_center">Yordam markazi</a></li>
                    </ul>
                </div>

                <div class="footer__col">
                    <h4 class="footer__title" data-i18n="footer.col2_title">Mijozlarga xizmat</h4>
                    <ul class="footer__links">
                        <li><a href="#" data-i18n="footer.link_account">Akkaunt</a></li>
                        <li><a href="#" data-i18n="nav.cart">Savatcha</a></li>
                        <li><a href="#" data-i18n="footer.link_delivery">Yetkazib berish</a></li>
                        <li><a href="#" data-i18n="footer.link_refunds">Qaytarish siyosati</a></li>
                        <li><a href="#" data-i18n="footer.link_privacy">Maxfiylik siyosati</a></li>
                    </ul>
                </div>

                <div class="footer__col">
                    <h4 class="footer__title" data-i18n="footer.col3_title">Aloqa</h4>
                    <ul class="footer__contact">
                        <li>
                            <i data-lucide="phone"></i>
                            <div>
                                <span>+998 71 123 45 67</span>
                                <span>+998 90 123 45 67</span>
                            </div>
                        </li>
                        <li>
                            <i data-lucide="mail"></i>
                            <span>info@techhouse.uz</span>
                        </li>
                        <li>
                            <i data-lucide="map-pin"></i>
                            <span data-i18n="footer.address">Toshkent sh., Amir Temur ko'chasi, 123</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="footer__features">
                <div class="footer__feature-card">
                    <i data-lucide="shield-check"></i>
                    <span data-i18n="home.features.guarantee">Kafolat</span>
                </div>
                <div class="footer__feature-card">
                    <i data-lucide="check-circle-2"></i>
                    <span data-i18n="footer.feature_quality">Sifat</span>
                </div>
                <div class="footer__feature-card">
                    <i data-lucide="credit-card"></i>
                    <span data-i18n="footer.feature_security">Xavfsiz to'lov</span>
                </div>
                <div class="footer__feature-card">
                    <i data-lucide="truck"></i>
                    <span data-i18n="home.features.delivery">Bepul yetkazib berish</span>
                </div>
            </div>

            <div class="footer__bottom">
                <p data-i18n="footer.copyright">&copy; 2026 Tech House. Barcha huquqlar himoyalangan.</p>
            </div>
        </div>
    </footer>

    <script src="translations.js"></script>
    <script src="script.js"></script>
    <script>
        const BRANCHES = [
            { id: 1, nameKey: "cart.branch_1", address: "Amir Temur ko'chasi, 123", cityKey: "cart.city_tashkent", phone: "+998 71 123 45 67" },
            { id: 2, nameKey: "cart.branch_2", address: "Bunyodkor ko'chasi, 45", cityKey: "cart.city_tashkent", phone: "+998 71 223 45 67" },
            { id: 3, nameKey: "cart.branch_3", address: "Registon ko'chasi, 12", cityKey: "cart.city_samarkand", phone: "+998 66 123 45 67" },
            { id: 4, nameKey: "cart.branch_4", address: "Mustaqillik ko'chasi, 88", cityKey: "cart.city_fergana", phone: "+998 73 123 45 67" },
            { id: 5, nameKey: "cart.branch_5", address: "Bahouddin Naqshband ko'chasi, 5", cityKey: "cart.city_bukhara", phone: "+998 65 123 45 67" }
        ];

        let deliveryMethod = 'delivery'; // 'delivery' or 'pickup'
        let selectedBranchId = 1;

        function setDeliveryMethod(method) {
            deliveryMethod = method;

            // Update UI buttons
            document.getElementById('method-delivery').classList.toggle('active', method === 'delivery');
            document.getElementById('method-pickup').classList.toggle('active', method === 'pickup');

            // Show/hide pickup info
            const pickupInfo = document.getElementById('pickup-info');
            const deliveryInfo = document.getElementById('delivery-info');

            pickupInfo.style.display = method === 'pickup' ? 'block' : 'none';
            deliveryInfo.style.display = method === 'delivery' ? 'block' : 'none';

            if (method === 'pickup') {
                populateBranches();
                updatePickupBranch();
            }

            renderCartPage();
        }

        function populateBranches() {
            const select = document.getElementById('branch-select');
            select.innerHTML = ''; // Clear existing options to re-render with new lang

            BRANCHES.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = `${t(branch.cityKey)}: ${t(branch.nameKey)}`;
                if (branch.id === selectedBranchId) option.selected = true;
                select.appendChild(option);
            });
        }

        function updatePickupBranch() {
            const select = document.getElementById('branch-select');
            selectedBranchId = parseInt(select.value);
            const branch = BRANCHES.find(b => b.id === selectedBranchId);
            const addressEl = document.getElementById('selected-branch-address');

            addressEl.innerHTML = `
                <p><strong>${t('cart.branch_address')}</strong> ${branch.address}</p>
                <p><strong>${t('cart.branch_phone')}</strong> ${branch.phone}</p>
            `;
        }

        // Specific logic to render the cart page
        function renderCartPage() {
            const container = document.getElementById('cart-items-container');
            const titleCount = document.getElementById('cart-title-count');
            const summaryCount = document.getElementById('summary-count');
            const subtotalEl = document.getElementById('summary-subtotal');
            const totalEl = document.getElementById('summary-total');

            if (!container) return;

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <i data-lucide="shopping-cart"></i>
                        <h2>${t('cart.empty')}</h2>
                        <p>${t('cart.empty_desc')}</p>
                        <a href="categories.html" class="btn btn--primary">${t('cart.start_shopping')}</a>
                    </div>
                `;
                titleCount.textContent = "0";
                summaryCount.textContent = "0";
                subtotalEl.textContent = "$0.00";
                totalEl.textContent = "$0.00";
                if (window.lucide) window.lucide.createIcons();
                return;
            }

            let cartHtml = '';
            let total = 0;
            let itemCount = 0;

            cart.forEach(item => {
                total += item.price * item.quantity;
                itemCount += item.quantity;
                cartHtml += `
                    <div class="cart-item">
                        <img src="${item.image}" alt="${item.name}" class="cart-item__img">
                        <div class="cart-item__info">
                            <h4 class="cart-item__name">${item.name}</h4>
                            <p class="cart-item__cat">${item.categorySlug || 'tech'}</p>
                            
                            <div class="cart-item__actions">
                                <div class="qty-control qty-control--sm">
                                    <button class="qty-btn" onclick="updateQuantity(${item.id}, -1)">
                                        <i data-lucide="minus"></i>
                                    </button>
                                    <span class="qty-val">${item.quantity}</span>
                                    <button class="qty-btn" onclick="updateQuantity(${item.id}, 1)">
                                        <i data-lucide="plus"></i>
                                    </button>
                                </div>
                                <button class="delete-btn" onclick="removeFromCart(${item.id})">
                                    <i data-lucide="trash-2"></i> ${t('cart.remove')}
                                </button>
                            </div>
                        </div>
                        <div class="cart-item__price">
                            ${(() => {
                        const priceInfo = getTieredPrice(item.price);
                        if (priceInfo.hasDiscount) {
                            return `
                                        <div class="price-stack">
                                            <span class="current-price">$${priceInfo.price}</span>
                                            <span class="old-price">$${item.price}</span>
                                            <span class="tier-badge">${priceInfo.tierName}</span>
                                        </div>
                                    `;
                        } else {
                            return `<span class="current-price">$${item.price}</span>`;
                        }
                    })()}
                            ${item.oldPrice > 0 && !getTieredPrice(item.price).hasDiscount ? `<span class="old-price">$${item.oldPrice}</span>` : ""}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = cartHtml;
            titleCount.textContent = itemCount;
            summaryCount.textContent = itemCount;
            subtotalEl.textContent = `$${total.toFixed(2)}`;

            // Membership Discount Calculation
            const discountRow = document.getElementById('membership-discount-row');
            const tierNameEl = document.getElementById('membership-tier-name');
            const discountAmountEl = document.getElementById('membership-discount-amount');
            const perksBox = document.getElementById('membership-perks-box');
            const perksList = document.getElementById('membership-perks-list');

            let finalTotal = total;
            let shippingCost = deliveryMethod === 'delivery' ? 50 : 0;

            if (currentUser && MEMBERSHIP_TIERS[currentUser.tier]) {
                const tier = MEMBERSHIP_TIERS[currentUser.tier];

                // Membership Shipping Perk: Free Delivery if they have it in perks
                if (tier.perks.includes('membership.perk.free_delivery')) {
                    shippingCost = 0;
                }

                const discountPercent = tier.discount;
                if (discountPercent > 0) {
                    const discountAmount = total * discountPercent;
                    finalTotal = total - discountAmount;

                    discountRow.style.display = 'flex';
                    tierNameEl.textContent = currentUser.tier;
                    discountAmountEl.textContent = `-$${discountAmount.toFixed(2)}`;
                } else {
                    discountRow.style.display = 'none';
                }

                // Show Perks
                perksBox.style.display = 'block';
                perksList.innerHTML = tier.perks.map(p => `<li><i data-lucide="check"></i> ${t(p)}</li>`).join('');
            } else {
                discountRow.style.display = 'none';
                perksBox.style.display = 'none';
            }

            // Update shipping amount UI
            const shippingAmountEl = document.getElementById('shipping-amount');
            if (shippingCost === 0) {
                shippingAmountEl.className = 'free-text';
                shippingAmountEl.textContent = t('cart.free');
            } else {
                shippingAmountEl.className = '';
                shippingAmountEl.textContent = `$${shippingCost.toFixed(2)}`;
            }

            totalEl.textContent = `$${(finalTotal + shippingCost).toFixed(2)}`;

            if (window.lucide) window.lucide.createIcons();
        }

        // Override updateCartUI for this page
        const originalUpdateCartUI = updateCartUI;
        window.updateCartUI = function () {
            originalUpdateCartUI();
            renderCartPage();
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) window.lucide.createIcons();
            renderCartPage();
        });
        // Re-render when content updates (language change)
        // We need to override variables or just hook into the global function if possible.
        // But updateContent is defined in script.js. redefining it here might be tricky if script.js loads later or earlier.
        // Actually script.js is loaded BEFORE this script block. So window.updateContent exists.

        const originalUpdateContent = window.updateContent;
        window.updateContent = function () {
            if (originalUpdateContent) originalUpdateContent();

            // Re-render branches and pickup info with new language
            if (deliveryMethod === 'pickup') {
                populateBranches();
                updatePickupBranch();
            }

            renderCartPage();
        }

    </script>
</body>

</html>